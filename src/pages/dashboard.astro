---
/**
 * Dashboard Page - Main learning center
 *
 * Displays welcome message, study status, statistics, and quick actions
 * Optimized to fetch only counts, not full flashcard data
 */
import Layout from "@/layouts/Layout.astro";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { getStats } from "@/lib/services/flashcard.service";

// ============================================================================
// Fetch User Data and Statistics
// ============================================================================

// Get user from locals (set by middleware)
const user = Astro.locals.user;

// Guard: This should never happen due to middleware, but TypeScript needs it
if (!user || !Astro.locals.supabase) {
  return Astro.redirect("/login");
}

// Fetch statistics (optimized - only counts, no flashcard data)
let stats = { totalCount: 0, studyCount: 0 };

try {
  stats = await getStats(Astro.locals.supabase, user.id);
} catch (error) {
  console.error("Failed to fetch dashboard stats:", error);
  // Continue with empty stats - will show empty state
}

const { totalCount, studyCount } = stats;

// Determine dashboard state
const isEmpty = totalCount === 0;
const hasStudyCards = studyCount > 0;
const isZeroInbox = totalCount > 0 && studyCount === 0;
---

<Layout title="Dashboard - 10xdevs Flashcards">
  <div class="container mx-auto max-w-7xl space-y-8 py-8" data-testid="dashboard-container">
    <!-- Welcome Section -->
    <div class="space-y-2" data-testid="dashboard-welcome">
      <h1 class="text-3xl font-bold tracking-tight" data-testid="dashboard-title">Dashboard</h1>
      <p class="text-muted-foreground" data-testid="dashboard-greeting">
        Cze, {user.firstName || user.email}!
      </p>
    </div>

    <!-- Hero Section: Dynamic Study Action Call -->
    {isEmpty && (
      <Alert data-testid="dashboard-empty-state">
        <AlertDescription class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <p class="font-medium">Nie masz jeszcze 偶adnych fiszek</p>
            <p class="text-sm text-muted-foreground">Zacznij od dodania pierwszej fiszki lub wygeneruj je automatycznie z AI</p>
          </div>
          <div class="flex gap-2">
            <Button asChild>
              <a href="/flashcards/new">Dodaj fiszk</a>
            </Button>
            <Button variant="outline" asChild>
              <a href="/ai/generate">Generuj z AI</a>
            </Button>
          </div>
        </AlertDescription>
      </Alert>
    )}

    {!isEmpty && hasStudyCards && (
      <Card class="border-primary bg-primary/5" data-testid="dashboard-study-card">
        <CardHeader>
          <CardTitle class="text-2xl">Gotowy do nauki?</CardTitle>
          <CardDescription data-testid="dashboard-study-count">
            Masz {studyCount} {studyCount === 1 ? "fiszk" : studyCount < 5 ? "fiszki" : "fiszek"} do powt贸rki
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Button size="lg" asChild data-testid="dashboard-start-study-button">
            <a href="/study">Rozpocznij nauk</a>
          </Button>
        </CardContent>
      </Card>
    )}

    {!isEmpty && isZeroInbox && (
      <Alert>
        <AlertDescription class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <p class="font-medium"> wietna robota! Zero Inbox</p>
            <p class="text-sm text-muted-foreground">Nie masz fiszek do powt贸rki. Wr贸 p贸藕niej lub dodaj nowe fiszki.</p>
          </div>
          <div class="flex gap-2">
            <Button variant="outline" asChild>
              <a href="/flashcards/new">Dodaj fiszk</a>
            </Button>
            <Button variant="outline" asChild>
              <a href="/ai/generate">Generuj z AI</a>
            </Button>
          </div>
        </AlertDescription>
      </Alert>
    )}

    <!-- Statistics Grid -->
    <div class="grid gap-6 md:grid-cols-2" data-testid="dashboard-stats-grid">
      <!-- Total Flashcards Stat -->
      <Card data-testid="dashboard-total-cards-stat">
        <CardHeader>
          <CardTitle>Wszystkie fiszki</CardTitle>
          <CardDescription>Fiszki w Twojej bazie</CardDescription>
        </CardHeader>
        <CardContent>
          <p class="text-4xl font-bold" data-testid="dashboard-total-count">{totalCount}</p>
        </CardContent>
      </Card>

      <!-- Study Count Stat -->
      <Card data-testid="dashboard-study-cards-stat">
        <CardHeader>
          <CardTitle>Do powt贸rki</CardTitle>
          <CardDescription>Fiszki czekajce na Ciebie</CardDescription>
        </CardHeader>
        <CardContent>
          <p class="text-4xl font-bold" data-testid="dashboard-study-count-stat">{studyCount}</p>
        </CardContent>
      </Card>
    </div>
  </div>
</Layout>
